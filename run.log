nasm -felf64 interrupts.S -o interrupts.o
ld -m elf_x86_64 -nostdlib -static -z max-page-size=0x1000 -T linker.ld kernel.o gdt.o idt.o pic.o keyboard.o pmm.o vmm.o heap.o serial.o console.o vfs.o initrd.o syscall.o user.o shell.o timer.o sched.o mouse.o desktop.o speaker.o compositor.o elf.o ipc.o security.o spinlock.o cpu.o lapic.o mutex.o semaphore.o fd.o pipe.o signal.o futex.o vm_area.o acpi.o ioapic.o rtc.o driver.o pci.o dma.o devfs.o ahci.o bga.o block.o partition.o bcache.o ext2.o klog.o ksyms.o aio.o drivers/e1000.o drivers/hda.o net/sys_arch.o net/core/pbuf.o net/core/netif.o net/core/ip.o net/core/tcp.o net/core/arp.o compat/linux/linux_syscall.o interrupts.o -o kernel.elf
# Create a directory for the ISO content
mkdir -p iso_root
# Copy the kernel, config, and initrd
cp -f kernel.elf limine.cfg initrd.tar limine/limine-bios.sys limine/limine-bios-cd.bin limine/limine-uefi-cd.bin iso_root/
# Create directory for EFI boot
mkdir -p iso_root/EFI/BOOT
cp -f limine/BOOTX64.EFI iso_root/EFI/BOOT/
cp -f limine/BOOTIA32.EFI iso_root/EFI/BOOT/
# Create the ISO using xorriso
xorriso -as mkisofs -b limine-bios-cd.bin \
	-no-emul-boot -boot-load-size 4 -boot-info-table \
	--efi-boot limine-uefi-cd.bin \
	-efi-boot-part --efi-boot-image --protective-msdos-label \
	iso_root -o myos.iso
xorriso 1.5.4 : RockRidge filesystem manipulator, libburnia project.

Drive current: -outdev 'stdio:myos.iso'
Media current: stdio file, overwriteable
Media status : is blank
Media summary: 0 sessions, 0 data blocks, 0 data,  272g free
Added to ISO image: directory '/'='/mnt/r/Projects/OS/iso_root'
xorriso : UPDATE :      10 files added in 1 seconds
xorriso : UPDATE :      10 files added in 1 seconds
xorriso : UPDATE :  32.95% done
ISO image produced: 2452 sectors
Written to medium : 2452 sectors at LBA 0
Writing to 'stdio:myos.iso' completed successfully.

# Install Limine to the ISO (BIOS boot support)
./limine/limine bios-install myos.iso
Physical block size of 512 bytes.
Installing to GPT. Logical block size of 512 bytes.
Secondary header at LBA 0x264f.
Secondary header valid.
GPT partition NOT specified. Attempting GPT embedding.
New maximum count of partition entries: 44.
Stage 2 to be located at 0x1a00 and 0x4c3800.
Reminder: Remember to copy the limine-bios.sys file in either
          the root, /boot, /limine, or /boot/limine directories of
          one of the partitions on the device, or boot will fail!
Limine BIOS stages installed successfully!
qemu-system-x86_64 -cdrom myos.iso -M q35 -serial file:serial.log \
-drive id=disk,file=disk.img,if=none,format=raw \
-device ahci,id=ahci \
-device ide-hd,drive=disk,bus=ahci.0
